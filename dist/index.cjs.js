"use strict";function t(t){return null}function e(t){return null}function n(t){return null}function r(t){return null}function o(){return{run:function(t){return t}}}Object.defineProperty(exports,"__esModule",{value:!0});var i,u,s={},a=-1;function f(t,e){s[t]=e}function d(t){return t in s?-1:(s[t]=++a,a)}function p(t){return t in s?s[t]:-1}function l(t){for(;;){if("function"!=typeof t.type)throw"non functional component";if(t.type==e)break;if("object"!=typeof(t=t.type.call(null,t.props)))throw"non react element"}return t}function c(e,o){for(var i=e.props,u=e.props.children,s=o+"."+i.name,a=i.params,h=[],v=0,g=u;v<g.length;v++){var x=g[v];if(x.type==n)for(var b=(w=x.props).params,y=0;y<b.length;++y){var O=p(o+"."+a[y]);if(O<0)throw"dependency must be defined before it's used";f(s+"."+b[y],O)}else if(x.type==r){var w,N=(w=x.props).name;if((S=p(s+"."+w.dep))<0)throw"dependency must be defined before it's used";f(s+"."+N,S)}else if(x.type==t){var S,m=x.props,k=(N=m.name,m.deps),D=[];if(k&&k.length)for(var W=0,E=k;W<E.length;W++){var V=p(s+"."+E[W]);if(V<0)throw"dependency must be defined before it's used";D.push(V)}if((S=d(s+"."+N))<0)throw"duplicate node name found "+s+"."+N;h.push({id:S,deps:D,gen:m.gen})}else{var I=l(x);h=h.concat(c(I,s))}}return h}function h(t,e,n){if(2==t[e])return!0;if(1==t[e])return!1;if(t[e]=1,e in n.binding)for(var r=0,o=n.binding[e];r<o.length;r++){if(!h(t,o[r],n))return!1}return t[e]=2,!0}function v(t){return"{id:"+t.id+",deps:"+JSON.stringify(t.deps)+",gen:"+t.gen.name+"},"}function g(t,e,n,r){return new(n||(n=Promise))((function(o,i){function u(t){try{a(r.next(t))}catch(t){i(t)}}function s(t){try{a(r.throw(t))}catch(t){i(t)}}function a(t){var e;t.done?o(t.value):(e=t.value,e instanceof n?e:new n((function(t){t(e)}))).then(u,s)}a((r=r.apply(t,e||[])).next())}))}function x(t,e){var n,r,o,i,u={label:0,sent:function(){if(1&o[0])throw o[1];return o[1]},trys:[],ops:[]};return i={next:s(0),throw:s(1),return:s(2)},"function"==typeof Symbol&&(i[Symbol.iterator]=function(){return this}),i;function s(i){return function(s){return function(i){if(n)throw new TypeError("Generator is already executing.");for(;u;)try{if(n=1,r&&(o=2&i[0]?r.return:i[0]?r.throw||((o=r.return)&&o.call(r),0):r.next)&&!(o=o.call(r,i[1])).done)return o;switch(r=0,o&&(i=[2&i[0],o.value]),i[0]){case 0:case 1:o=i;break;case 4:return u.label++,{value:i[1],done:!1};case 5:u.label++,r=i[1],i=[0];continue;case 7:i=u.ops.pop(),u.trys.pop();continue;default:if(!(o=u.trys,(o=o.length>0&&o[o.length-1])||6!==i[0]&&2!==i[0])){u=0;continue}if(3===i[0]&&(!o||i[1]>o[0]&&i[1]<o[3])){u.label=i[1];break}if(6===i[0]&&u.label<o[1]){u.label=o[1],o=i;break}if(o&&u.label<o[2]){u.label=o[2],u.ops.push(i);break}o[2]&&u.ops.pop(),u.trys.pop();continue}i=e.call(t,u)}catch(t){i=[6,t],r=0}finally{n=o=0}if(5&i[0])throw i[1];return{value:i[0]?i[1]:void 0,done:!0}}([i,s])}}}exports.WorkflowValidationStatus=void 0,(i=exports.WorkflowValidationStatus||(exports.WorkflowValidationStatus={}))[i.OK=0]="OK",i[i.EmptyWorkflow=1]="EmptyWorkflow",i[i.NodesDisorder=2]="NodesDisorder",i[i.InputOutOfNodes=3]="InputOutOfNodes",i[i.ZeroDepOutOfNodes=4]="ZeroDepOutOfNodes",i[i.OutputOutOfNodes=5]="OutputOutOfNodes",i[i.BindingOutOfNodes=6]="BindingOutOfNodes",i[i.DepNotFoundInBinding=7]="DepNotFoundInBinding",i[i.BindingNotFoundInDep=8]="BindingNotFoundInDep",i[i.CircularDetected=9]="CircularDetected",exports.ExecutionStatus=void 0,(u=exports.ExecutionStatus||(exports.ExecutionStatus={}))[u.NotStarted=0]="NotStarted",u[u.Running=1]="Running",u[u.Cancelled=2]="Cancelled",u[u.Failure=3]="Failure",u[u.Done=4]="Done",exports.InputNodeComponent=n,exports.NodeComponent=t,exports.OutputNodeComponent=r,exports.WorkflowComponent=e,exports.buildJsxWorkflow=function(e){for(var i="",u=[],h={},v=[],g=0,x=l(e).props.children;g<x.length;g++){var b=x[g];if(b.type==n)for(var y=0,O=(S=b.props).params;y<O.length;y++){var w=O[y];if((m=d("."+w))<0)throw"duplicate node name found ."+w;u.push({id:m,deps:[],gen:o})}else if(b.type==r){var N=(S=b.props).name;if((m=p("."+S.dep))<0)throw"dependency must be defined before it's used";f("."+N,m),h[m]=N}else if(b.type==t){N=(S=b.props).name;var S,m,k=S.deps,D=[];if(k&&k.length)for(var W=0,E=k;W<E.length;W++){var V=p("."+E[W]);if(V<0)throw"dependency must be defined before it's used";D.push(V)}if((m=d("."+N))<0)throw"duplicate node name found ."+N;v.push({id:m,deps:D,gen:S.gen})}else{var I=l(b);v=v.concat(c(I,i))}}s={},a=-1;var F=function(){var t=[],e=[],n={},r=[],o={},i={build:function(){return r.sort((function(t,e){return t.id>e.id?1:-1})),{inputs:t,outputs:n,nodes:r,binding:o,zeroDepNodes:e}},input:function(e){r=r.concat(e);for(var n=0,o=e;n<o.length;n++){var u=o[n];t.push(u.id)}return i},output:function(t){return n=t,i},next:function(t){for(var n=0,u=t;n<u.length;n++){var s=u[n];0==s.deps.length&&e.push(s.id);for(var a=0,f=s.deps;a<f.length;a++){var d=f[a];d in o?o[d].push(s.id):o[d]=[s.id]}}return r=r.concat(t),i}};return i}();return F.input(u).next(v).output(h),F.build()},exports.createWorkflowExecutor=function(t){var e=t,n=0,r=exports.ExecutionStatus.NotStarted,o={},i={},u=[],s=[];function a(t,n){if(void 0===n)return[];var r=n;"object"==typeof n&&(r=Object.freeze(r)),t in e.outputs&&(i[e.outputs[t]]=r);var u=[],s=e.binding[t];if(s&&s.length)for(var a=0,f=s;a<f.length;a++){var d=f[a];d in o||(o[d]={}),o[d][t]=r;var p=e.nodes[d];if(Object.keys(o[d]).length==p.deps.length){for(var l=[],c=0,h=p.deps;c<h.length;c++){var v=h[c];l.push(o[d][v])}var g={node:p.gen(),id:p.id,inputs:l};delete o[d],u.push(g)}}return u}var f={state:function(){return r},reset:function(){r=exports.ExecutionStatus.NotStarted,o={},i={},u=[],s=[]},setTimeout:function(t){n=t},cancel:function(){r=exports.ExecutionStatus.Cancelled;for(var t=0,e=u;t<e.length;t++){var n=e[t];n.node.cancel&&n.node.cancel()}},run:function(){for(var t=[],o=0;o<arguments.length;o++)t[o]=arguments[o];return g(this,void 0,void 0,(function(){function o(t){var e=this;return new Promise((function(n,i){return g(e,void 0,void 0,(function(){var e,i,d=this;return x(this,(function(p){switch(p.label){case 0:for(e=function(){var e,n=t.pop(),i=void 0;try{i=(e=n.node).run.apply(e,n.inputs)}catch(t){return r=exports.ExecutionStatus.Failure,f.cancel(),"break"}if(i instanceof Promise){u.push(n);var p=i.then((function(t){return g(d,void 0,void 0,(function(){var e,i;return x(this,(function(d){return r!=exports.ExecutionStatus.Running||((e=u.indexOf(n))>=0&&u.splice(e,1),(i=a.call(f,n.id,t)).length&&s.push(o(i))),[2]}))}))})).catch((function(){r=exports.ExecutionStatus.Failure,f.cancel()}));s.push(p)}else{var l=a.call(f,n.id,i);t=t.concat(l)}};t.length&&"break"!==e(););p.label=1;case 1:return s.length>0?(i=s.splice(0,s.length),[4,Promise.all(i)]):[3,3];case 2:return p.sent(),[3,1];case 3:return n(!0),[2]}}))}))}))}var d,p,l,c,h;return x(this,(function(u){switch(u.label){case 0:for(n>0&&setTimeout((function(){r==exports.ExecutionStatus.Running&&f.cancel()}),n),r=exports.ExecutionStatus.Running,d=[],p=0;p<t.length;++p)d.push({node:e.nodes[e.inputs[p]].gen(),id:e.inputs[p],inputs:[t[p]]});for(l=0,c=e.zeroDepNodes;l<c.length;l++)h=c[l],d.push({node:e.nodes[h].gen(),id:h,inputs:[]});return[4,o(d)];case 1:return u.sent(),r==exports.ExecutionStatus.Running&&(r=Object.keys(e.outputs).length==Object.keys(i).length?exports.ExecutionStatus.Done:exports.ExecutionStatus.Failure),[2,i]}}))}))}};return f},exports.dumpWorkflow=function(t){var e="{";e+="inputs:".concat(JSON.stringify(t.inputs),","),e+="zeroDepNodes:".concat(JSON.stringify(t.zeroDepNodes),","),e+="nodes:[";for(var n=0,r=t.nodes;n<r.length;n++){e+=v(r[n])}for(var o in e+="],",e+="outputs:{",t.outputs)e+=o+":"+JSON.stringify(t.outputs[o])+",";for(var o in e+="},",e+="binding:{",t.binding)e+=o+":"+JSON.stringify(t.binding[o])+",";return e+="},",e+="}"},exports.unitNodeGenerator=o,exports.validateWorkflow=function(t){var e=t.nodes.length;if(e<=0)return exports.WorkflowValidationStatus.EmptyWorkflow;for(var n=0;n<e;++n)if(t.nodes[n].id!=n)return exports.WorkflowValidationStatus.NodesDisorder;for(var r=0,o=t.inputs;r<o.length;r++){var i=o[r];if(i<0||i>=t.nodes.length)return exports.WorkflowValidationStatus.InputOutOfNodes}for(var u=0,s=t.zeroDepNodes;u<s.length;u++){var a=s[u];if(a<0||a>=t.nodes.length)return exports.WorkflowValidationStatus.ZeroDepOutOfNodes}for(var f=0,d=Object.keys(t.outputs);f<d.length;f++){var p=d[f],l=parseInt(p);if(l<0||l>=e)return exports.WorkflowValidationStatus.OutputOutOfNodes}for(var c in t.binding){var v=parseInt(c);if(v<0||v>=e)return exports.WorkflowValidationStatus.BindingOutOfNodes;for(var g=0,x=t.binding[v];g<x.length;g++){if((k=x[g])<0||k>=e)return exports.WorkflowValidationStatus.BindingOutOfNodes}}for(var b=0,y=t.nodes;b<y.length;b++){if((V=y[b]).deps.length)for(var O=0,w=V.deps;O<w.length;O++){if(!(w[O]in t.binding))return exports.WorkflowValidationStatus.DepNotFoundInBinding}}for(var c in t.binding)for(var N=parseInt(c),S=0,m=t.binding[N];S<m.length;S++){var k=m[S];if(t.nodes[k].deps.indexOf(N)<0)return exports.WorkflowValidationStatus.BindingNotFoundInDep}for(var D=Array(e).fill(0),W=0,E=t.nodes;W<E.length;W++){var V;if(!h(D,(V=E[W]).id,t))return exports.WorkflowValidationStatus.CircularDetected}return exports.WorkflowValidationStatus.OK};
